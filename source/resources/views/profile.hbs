
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thông tin tài khoản</title>
    <link rel="stylesheet" href="/css/app.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
    <div class="information-box">
        <!-- Cột trái: Thông tin tài khoản (ô đen) -->
        <div class="info-box shadow">
            <h2><i class="fa-solid fa-user"></i> Thông tin tài khoản</h2>
            <p><strong><i class="fa-solid fa-user-tag"></i> Tên người dùng:</strong> {{user.username}}</p>
            <p><strong><i class="fa-solid fa-envelope"></i> Email:</strong> {{user.email}}</p>
            <p><strong><i class="fa-solid fa-venus-mars"></i> Giới tính:</strong> {{user.gender}}</p>
            <p><strong><i class="fa-solid fa-cake-candles"></i> Tuổi:</strong> {{user.age}}</p>
            <button id="edit-profile-btn" class="btn btn-warning btn-sm mt-2">Chỉnh sửa</button>
                <form id="edit-form" method="POST" action="/profile/edit" style="display: none;">
                    <input type="text" name="username" value="{{user.username}}">
                    <input type="email" name="email" value="{{user.email}}">
                    <select name="gender">
                        <option value="Nam" {{#ifEquals user.gender "Nam"}}selected{{/ifEquals}}>Nam</option>   
                        <option value="Nữ" {{#ifEquals user.gender "Nữ"}}selected{{/ifEquals}}>Nữ</option>
                        <option value="Khác" {{#ifEquals user.gender "Khác"}}selected{{/ifEquals}}>Khác</option>
                    </select>
                    <input type="number" name="age" value="{{user.age}}">
                    <button type="submit">Lưu</button>
                </form>
        <hr>
        <h3 class="task-title"><i class="fa-solid fa-list-check"></i> To-do-list</h3>

        <form action="/profile" method="POST" class="d-flex gap-2 mt-2">
            <input type="text" name="content" placeholder="Nhập việc cần làm..." required class="form-control">
            <button type="submit" class="btn btn-success btn-sm">
                <i class="fa-solid fa-plus"></i> Thêm
            </button>
        </form>

        <form id="task-complete-form" action="/profile/completed" method="POST">
            <ul class="task-list mt-3">
                {{#each tasks}}
        <li class="d-flex justify-content-between align-items-center mb-2">
            <label class="mb-0">
                <input type="checkbox" name="completedTasks" value="{{this._id}}">
                {{#if content}}{{content}}{{else}}<i>(Không có nội dung)</i>{{/if}}
            </label>

            <button type="button" class="btn btn-sm btn-danger" onclick="deleteTask('{{this._id}}')">
                <i class="fa-solid fa-trash"></i> Xoá
            </button>
        </li>
    {{/each}}
            </ul>
            
            <button type="submit" class="btn btn-outline-success mt-2"><i class="fa-solid fa-check"></i> Hoàn thành</button>
            <a href="/profile/completed" class="btn btn-secondary mt-2">
                <i class="fa-solid fa-clock-rotate-left"></i> Xem việc đã hoàn thành
            </a>
            <p>Số lượng việc cần làm: {{tasks.length}}</p>
        </form>
        
        

        </div>

        <!-- Cột phải: chức năng -->
        <div class="function-area">
            <!-- Ô đỏ: Đổi avatar & mật khẩu -->
            <div class="function-box shadow">
                <h3><i class="fa-solid fa-image"></i> Ảnh đại diện</h3>
                <img src="{{#if user.avatar}}{{user.avatar}}{{else}}/uploads/avatars/default-avatar.png{{/if}}" alt="Avatar" class="avatar-preview" />
                
                <div class="avatar-form">
                    <form action="/profile/change-avatar" method="POST" enctype="multipart/form-data">
                        <input type="file" name="avatar" accept="image/*" required>
                        <div class="avatar-action-row">
                            <button type="submit" class="btn btn-info">
                                <i class="fa-solid fa-upload"></i> Cập nhật ảnh đại diện
                            </button>
                        </div>
                    </form>

                    <form id="delete-avatar-form" action="/profile/delete-avatar" method="POST">
                        <button type="button" id="delete-avatar-btn" class="btn btn-danger">
                            <i class="fa-solid fa-dumpster"></i> Xoá ảnh đại diện
                        </button>
                    </form>
                </div>

                <hr>
                <h3><i class="fa-solid fa-key"></i> Đổi mật khẩu</h3>
                <form action="/profile/change-password" method="POST">
                    <input type="password" name="currentPassword" placeholder="Mật khẩu hiện tại" required>
                    <input type="password" name="newPassword" placeholder="Mật khẩu mới" required>
                    <button type="submit" class="btn btn-warning"><i class="fa-solid fa-rotate"></i> Đổi mật khẩu</button>
                </form>
            </div>

            <!-- Ô vàng: Xoá và quay lại -->
            <div class="danger-box shadow">
                <form id="delete-account-form" action="/profile/delete" method="POST">
                    <button type="button" id="delete-account-btn" class="btn btn-danger">
                        <i class="fa-solid fa-trash"></i> Xoá tài khoản
                    </button>
                </form>
                <a href="/" class="btn btn-back"><i class="fa-solid fa-left-long"></i> Quay về trang chủ</a>
            </div>
        </div>
    </div>

<form id="deleteForm" method="POST" style="display:none;"></form>

<script>
    function deleteTask(taskId) {
        if (confirm('Bạn có chắc muốn xoá task này không?')) {
            const form = document.getElementById('deleteForm');
            form.action = `/profile/delete/${taskId}`;
            form.submit();
        }
    }

    document.getElementById("edit-profile-btn").addEventListener("click", function () {
        // toggle fomr chỉnh sửa thông tin tài khoản
        const form = document.getElementById("edit-form");
        form.style.display = form.style.display === "none" ? "block" : "none";
    });
        // Xác nhận xoá tài khoản bằng SweetAlert2
    document.getElementById("delete-account-btn").addEventListener("click", function () {
        Swal.fire({
            title: 'Bạn có chắc chắn?',
            text: 'Thao tác này sẽ xóa vĩnh viễn tài khoản của bạn!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Xoá tài khoản',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById("delete-account-form").submit();
            }
        });
    });

    document.getElementById("delete-avatar-btn").addEventListener("click", function () {
        Swal.fire({
            title: 'Bạn có chắc chắn?',
            text: 'Thao tác này sẽ xóa ảnh đại diện của bạn!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Xoá ảnh đại diện',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById("delete-avatar-form").submit();
            }
        });
    });
    
</script>

{{#if success}}
<script>
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'success',
        title: '{{success}}',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true
    });
</script>
{{/if}}


{{#if error}}
<script>
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'error',
        title: '{{error}}',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true
    });
</script>
{{/if}}

</body>

</html>
